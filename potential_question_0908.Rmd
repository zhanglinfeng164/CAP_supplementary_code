---
title: "CAP_stastics"
author: "Zhang Linfeng"
date: "2022/9/1"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

##PERMANOVA
```{r}
library(compositions)
#library(tidyverse)
library(vegan)
library(reshape2)
library(dplyr)
library(ggplot2)
library(stringr)
library(phyloseq)
library(RColorBrewer)
library(tidyr)
library(ggsignif)
library(stringr)
library(ggthemes)
```

##单因素PERMANOVA
```{r}
metadata = read.csv('F:/ZLF/CAP/data/relative_data/metadata-all-220825.csv',row.names = 1)
df = read.csv("F:/ZLF/CAP/data/relative_data/dfall-220617.csv",row.names=1)
vals = c('onsetdays_new','sex','age','BMI', 'city',
         'smoke','basic_LRT_disease','pre_biotic','pre_immunosuppressive',
         'respiratory.support.invasive','death_case1','severe_case') 

tot.df = data.frame(R2 = rep(NA,length(vals)),
                    pval = rep(NA,length(vals)))
row.names(tot.df) <- vals
sub.meta = filter(metadata,d == 1)

for (val in vals){
  d1.meta = sub.meta[!is.na(sub.meta[,val]),]
  rownames(d1.meta) <- d1.meta$raw_id
  d1.df = df[,rownames(d1.meta)] %>% t() %>% as.data.frame()
  #View(sub.df)
  OTU = phyloseq::otu_table(d1.df, taxa_are_rows = F)
  physeq = phyloseq(OTU)
  jsd=phyloseq::distance(physeq, method = "jsd")
  
  res = adonis(as.formula(paste0("jsd~",val)),
               data = d1.meta, permutations = 999)
  
  pval = res$aov.tab$`Pr(>F)`[1]
  r2 = res$aov.tab$R2[1]
  tot.df[val,'pval'] = pval
  tot.df[val,'R2'] = r2
}

single_res <- tot.df
single_res$padj <- p.adjust (single_res$pval, method = 'fdr', n = (length(vals)))

single_res$group <- 'single'
single_res <- single_res[order(single_res[,'R2'],decreasing = T),]

single_res$value <- rownames(single_res)
```

##多因素PERMANOVA
```{r}
metadata = read.csv('F:/ZLF/CAP/data/relative_data/metadata-all-220825.csv',row.names = 1)
df = read.csv("F:/ZLF/CAP/data/relative_data/dfall-220617.csv",row.names=1)
vals = c('age', 'city','respiratory.support.invasive','death_case1','severe_case') 
vals1 = c('onsetdays_new','sex','age','BMI', 'city',
         'smoke','basic_LRT_disease','pre_biotic','pre_immunosuppressive',
         'respiratory.support.invasive','death_case1','severe_case') 
tot.df = data.frame(R2 = rep(NA,length(vals)),
                    pval = rep(NA,length(vals)))
row.names(tot.df) <- vals
sub.meta = filter(metadata,d == 1)
for (val in vals) {sub.meta <- sub.meta[!is.na(sub.meta[,val]),]}
rownames(sub.meta) <- sub.meta$raw_id

sub.df = df[,rownames(sub.meta)] %>% t() %>% as.data.frame()

nrow(sub.meta)

OTU = phyloseq::otu_table(sub.df, taxa_are_rows = F)
physeq = phyloseq(OTU)
jsd=phyloseq::distance(physeq, method = "jsd")

res_11 <- adonis2(as.formula(paste0("jsd~",'age+city+respiratory.support.invasive+death_case1+severe_case')),
                  data = sub.meta,permutations = 30000,by = 'margin')
res_11

tot.df$R2 = res_1$R2[1:5]
tot.df$pval = res_1$`Pr(>F)`[1:5]


multi_res <- tot.df
multi_res$padj <- p.adjust (multi_res$pval, method = 'fdr', n = (length(vals)))
multi_res$group <- 'multi'
multi_res <- multi_res[order(multi_res[,'R2'],decreasing = T),]

multi_res$value = rownames(multi_res)

a <- single_res[setdiff(rownames(single_res),rownames(multi_res)),]
a$R2 = 0
a$pval = 0
a$padj = 0
a$group = 'multi'

multi_res <- rbind(multi_res,a)

```

##Missing value statistics
```{r}
metadata = read.csv('F:/ZLF/CAP/data/relative_data/metadata-all-220825.csv',row.names = 1)
sub.meta = filter(metadata,d == 1)
d1.meta = filter(metadata,d == 1)
df = read.csv("F:/ZLF/CAP/data/relative_data/dfall-220617.csv",row.names=1)
vals = c('onsetdays_new','sex','age','BMI', 'city',
         'smoke','basic_LRT_disease','pre_biotic','pre_immunosuppressive',
         'respiratory.support.invasive','death_case1','severe_case') 
for (val in vals) {sub.meta <- sub.meta[!is.na(sub.meta[,val]),]}
rownames(sub.meta) <- sub.meta$raw_id
print(paste0(nrow(sub.meta),' patients remand after add all metadata, ',1-nrow(sub.meta)/nrow(d1.meta),' was removed.'))

##单因素显著
metadata = read.csv('F:/ZLF/CAP/data/relative_data/metadata-all-220825.csv',row.names = 1)
sub.meta = filter(metadata,d == 1)
d1.meta = filter(metadata,d == 1)
df = read.csv("F:/ZLF/CAP/data/relative_data/dfall-220617.csv",row.names=1)
vals = c('age','city','respiratory.support.invasive','death_case1','severe_case') 
for (val in vals) {sub.meta <- sub.meta[!is.na(sub.meta[,val]),]}
rownames(sub.meta) <- sub.meta$raw_id
print(paste0(nrow(sub.meta),' patients remand after add significant metadata, ',1-nrow(sub.meta)/nrow(d1.meta),' was removed.'))


```

##plot

```{r}
plot1 <- rbind(single_res,multi_res)
levs <- c("city","age","severe_case","death_case1","respiratory.support.invasive","onsetdays_new","pre_immunosuppressive","basic_LRT_disease","pre_biotic","sex","smoke","BMI")
plot1$value <- factor(plot1$value,levels = rev(levs))
#plot1$value <- rownames(plot1)
p <- ggplot(plot1,aes(x = R2,y = value))+
  geom_bar(aes(alpha = group),fill = 'forestgreen',stat = "identity", position = position_dodge())+
  theme_bw()+
  xlim(0,0.15)+
  geom_hline(yintercept = 8.55)+
  #scale_x_discrete(limits = positions) +
  scale_alpha_manual(values=c(1,0.6)) 
p
p1 <- ggplot(plot1,aes(y = R2,x = group))+
  geom_bar(aes(fill = value),stat = "identity", position = 'stack')+
  theme_bw() +
  geom_vline(xintercept = 3.1)+
  #scale_x_discrete(limits = positions) +
  scale_alpha_manual(values=c(1,0.6)) 

plot1
```

##maaslin
```{r}
df = read.csv("F:/ZLF/CAP/data/relative_data/dfall-220617.csv",row.names=1)
metadata = read.csv('F:/ZLF/CAP/data/relative_data/metadata-all-220825.csv',row.names = 1)
sub.meta <- filter(metadata,d == 1) 
rownames(sub.meta) <- sub.meta$raw_id
parameter<-c('onsetdays_new','city','age','severe_case','death_case1','sex', 'BMI','pre_immunosuppressive','basic_LRT_disease','pre_biotic','smoke',"respiratory.support.invasive")

sub.df <- df[,rownames(sub.meta)]

fit_data <- Maaslin2(
  input_data = sub.df, 
  input_metadata = sub.meta,
  #output = 'C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0810_filt',
  output = 'C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0817_filt',
  transform = "AST",
  #normalization = 'NONE',
  fixed_effects = parameter,
  reference ='city,HB',
  min_prevalence = 0.1,
  min_abundance = 0.001
  #random_effects = 'subject'
)


```


##maaslin plot
```{r}

maaslin_res<-read.table('C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0817_filt/significant_results.tsv',sep = "\t",header = TRUE, )
#maaslin_res<-read.table('C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0817_filt/all_results.tsv',sep = "\t",header = TRUE) %>% filter(qval <= 0.3)

maaslin_res_severity<-filter(maaslin_res,metadata == 'severe_case') %>% select(feature,value,coef,N,N.not.0,pval,qval)

maaslin_res_severity$severity<-rep('0',length(rownames(maaslin_res_severity)))
for (i in 1:length(rownames(maaslin_res_severity))) {
  if(maaslin_res_severity$coef[i]>0){
    maaslin_res_severity$severity[i] = 'yes'
  }else {
    maaslin_res_severity$severity[i] = 'no'
  }
}

maaslin_res_severity$coef<-sign(maaslin_res_severity$coef)*maaslin_res_severity$coef
maaslin_res_severity<-maaslin_res_severity[order(maaslin_res_severity$coef),]
maaslin_res_severity_yes<-filter(maaslin_res_severity,severity == 'yes')
maaslin_res_severity_no<-filter(maaslin_res_severity,severity == 'no')

maaslin_res_severity<-rbind(maaslin_res_severity_no,maaslin_res_severity_yes)

maaslin_res_severity$feature<-factor(maaslin_res_severity$feature,levels = maaslin_res_severity$feature)


p1 <- ggplot(maaslin_res_severity,aes(x=coef,y=feature))+
  geom_bar(stat = "identity",fill = ifelse(maaslin_res_severity$severity == 'yes',"#E69F00","#56B4E9"),alpha = 0.7)+
  theme_few()
p1

maaslin_res<-read.table('C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0817_filt/significant_results.tsv',sep = "\t",header = TRUE, )
#maaslin_res<-read.table('C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0810_filt/all_results.tsv',sep = "\t",header = TRUE) %>% filter(qval <= 0.3)

#maaslin_res<-read.table(paste0(output_path,'city_age_all/','significant_results.tsv'),sep = "\t",header = TRUE, )

maaslin_res_severity<-filter(maaslin_res,metadata == 'age')

maaslin_res_severity<-select(maaslin_res_severity,feature,value,coef,pval,qval)

maaslin_res_severity$severity<-rep('0',length(rownames(maaslin_res_severity)))
for (i in 1:length(rownames(maaslin_res_severity))) {
  if(maaslin_res_severity$coef[i]>0){
    maaslin_res_severity$severity[i] = 'positive'
  }else {
    maaslin_res_severity$severity[i] = 'negative'
  }
  
}
maaslin_res_severity$coef<-abs(maaslin_res_severity$coef)
maaslin_res_severity<-maaslin_res_severity[order(maaslin_res_severity$coef),]
maaslin_res_severity_yes<-filter(maaslin_res_severity,severity == 'positive')
maaslin_res_severity_no<-filter(maaslin_res_severity,severity == 'negative')

maaslin_res_severity<-rbind(maaslin_res_severity_no,maaslin_res_severity_yes)

maaslin_res_severity$feature<-factor(maaslin_res_severity$feature,levels = maaslin_res_severity$feature)

colnames(maaslin_res_severity)[4]<-'age'
p2 <- ggplot()+
  #  geom_bar(data=maaslin_res_age,aes(x=coef,y=feature),stat = "identity",fill = "#EE6A50")+
  geom_bar(data=maaslin_res_severity,aes(x=coef,y=feature),stat = "identity",fill = ifelse(maaslin_res_severity$age == 'positive',"darkred","steelblue4"),alpha = 0.7)+
  theme_bw()
p2

maaslin_res<-read.table('C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0817_filt/significant_results.tsv',sep = "\t",header = TRUE, )
#maaslin_res<-read.table('C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0817_filt/all_results.tsv',sep = "\t",header = TRUE) %>% filter(qval <= 0.3)

maaslin_res_severity<-filter(maaslin_res,metadata == 'death_case1') %>% select(feature,value,coef,N,N.not.0,pval,qval)

maaslin_res_severity$severity<-rep('0',length(rownames(maaslin_res_severity)))
for (i in 1:length(rownames(maaslin_res_severity))) {
  if(maaslin_res_severity$coef[i]>0){
    maaslin_res_severity$severity[i] = 'yes'
  }else {
    maaslin_res_severity$severity[i] = 'no'
  }
}

maaslin_res_severity$coef<-sign(maaslin_res_severity$coef)*maaslin_res_severity$coef
maaslin_res_severity<-maaslin_res_severity[order(maaslin_res_severity$coef),]
maaslin_res_severity_yes<-filter(maaslin_res_severity,severity == 'yes')
maaslin_res_severity_no<-filter(maaslin_res_severity,severity == 'no')

maaslin_res_severity<-rbind(maaslin_res_severity_no,maaslin_res_severity_yes)

maaslin_res_severity$feature<-factor(maaslin_res_severity$feature,levels = maaslin_res_severity$feature)


p3 <- ggplot(maaslin_res_severity,aes(x=coef,y=feature))+
  geom_bar(stat = "identity",fill = ifelse(maaslin_res_severity$severity == 'yes',"#E69F00","#56B4E9"),alpha = 0.7)+
  theme_few()
p3

```




##maaslin
```{r}
library(Maaslin2)
df = read.csv("F:/ZLF/CAP/data/relative_data/dfall-220617.csv",row.names=1)
metadata = read.csv('F:/ZLF/CAP/data/relative_data/metadata-all-220825.csv',row.names = 1)
sub.meta <- filter(metadata,d == 1) 
rownames(sub.meta) <- sub.meta$raw_id
parameter<-c('city','age','severe_case','death_case1',"respiratory.support.invasive")

sub.df <- df[,rownames(sub.meta)]

fit_data <- Maaslin2(
  input_data = sub.df, 
  input_metadata = sub.meta,
  #output = 'C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0810_filt',
  output = 'C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0905_filt',
  transform = "AST",
  #normalization = 'NONE',
  fixed_effects = parameter,
  reference ='city,HB',
  min_prevalence = 0.1,
  min_abundance = 0.001
  #random_effects = 'subject'
)


```



##maaslin plot
```{r}

maaslin_res<-read.table('C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0905_filt/significant_results.tsv',sep = "\t",header = TRUE, )
#maaslin_res<-read.table('C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0817_filt/all_results.tsv',sep = "\t",header = TRUE) %>% filter(qval <= 0.3)

maaslin_res_severity<-filter(maaslin_res,metadata == 'severe_case') %>% select(feature,value,coef,N,N.not.0,pval,qval)

maaslin_res_severity$severity<-rep('0',length(rownames(maaslin_res_severity)))
for (i in 1:length(rownames(maaslin_res_severity))) {
  if(maaslin_res_severity$coef[i]>0){
    maaslin_res_severity$severity[i] = 'yes'
  }else {
    maaslin_res_severity$severity[i] = 'no'
  }
}

maaslin_res_severity$coef<-sign(maaslin_res_severity$coef)*maaslin_res_severity$coef
maaslin_res_severity<-maaslin_res_severity[order(maaslin_res_severity$coef),]
maaslin_res_severity_yes<-filter(maaslin_res_severity,severity == 'yes')
maaslin_res_severity_no<-filter(maaslin_res_severity,severity == 'no')

maaslin_res_severity<-rbind(maaslin_res_severity_no,maaslin_res_severity_yes)

maaslin_res_severity$feature<-factor(maaslin_res_severity$feature,levels = maaslin_res_severity$feature)


p1 <- ggplot(maaslin_res_severity,aes(x=coef,y=feature))+
  geom_bar(stat = "identity",fill = ifelse(maaslin_res_severity$severity == 'yes',"#E69F00","#56B4E9"),alpha = 0.7)+
  theme_few()
p1

maaslin_res<-read.table('C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0905_filt/significant_results.tsv',sep = "\t",header = TRUE, )
#maaslin_res<-read.table('C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0810_filt/all_results.tsv',sep = "\t",header = TRUE) %>% filter(qval <= 0.3)

#maaslin_res<-read.table(paste0(output_path,'city_age_all/','significant_results.tsv'),sep = "\t",header = TRUE, )

maaslin_res_severity<-filter(maaslin_res,metadata == 'age')

maaslin_res_severity<-select(maaslin_res_severity,feature,value,coef,pval,qval)

maaslin_res_severity$severity<-rep('0',length(rownames(maaslin_res_severity)))
for (i in 1:length(rownames(maaslin_res_severity))) {
  if(maaslin_res_severity$coef[i]>0){
    maaslin_res_severity$severity[i] = 'positive'
  }else {
    maaslin_res_severity$severity[i] = 'negative'
  }
  
}
maaslin_res_severity$coef<-abs(maaslin_res_severity$coef)
maaslin_res_severity<-maaslin_res_severity[order(maaslin_res_severity$coef),]
maaslin_res_severity_yes<-filter(maaslin_res_severity,severity == 'positive')
maaslin_res_severity_no<-filter(maaslin_res_severity,severity == 'negative')

maaslin_res_severity<-rbind(maaslin_res_severity_no,maaslin_res_severity_yes)

maaslin_res_severity$feature<-factor(maaslin_res_severity$feature,levels = maaslin_res_severity$feature)

colnames(maaslin_res_severity)[4]<-'age'
p2 <- ggplot()+
  #  geom_bar(data=maaslin_res_age,aes(x=coef,y=feature),stat = "identity",fill = "#EE6A50")+
  geom_bar(data=maaslin_res_severity,aes(x=coef,y=feature),stat = "identity",fill = ifelse(maaslin_res_severity$age == 'positive',"darkred","steelblue4"),alpha = 0.7)+
  theme_bw()
p2



#maaslin_res<-read.table('C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0817_filt/all_results.tsv',sep = "\t",header = TRUE) %>% filter(qval <= 0.3)

maaslin_res_severity<-filter(maaslin_res,metadata == 'death_case1') %>% select(feature,value,coef,N,N.not.0,pval,qval)

maaslin_res_severity$severity<-rep('0',length(rownames(maaslin_res_severity)))
for (i in 1:length(rownames(maaslin_res_severity))) {
  if(maaslin_res_severity$coef[i]>0){
    maaslin_res_severity$severity[i] = 'yes'
  }else {
    maaslin_res_severity$severity[i] = 'no'
  }
}

maaslin_res_severity$coef<-sign(maaslin_res_severity$coef)*maaslin_res_severity$coef
maaslin_res_severity<-maaslin_res_severity[order(maaslin_res_severity$coef),]
maaslin_res_severity_yes<-filter(maaslin_res_severity,severity == 'yes')
maaslin_res_severity_no<-filter(maaslin_res_severity,severity == 'no')

maaslin_res_severity<-rbind(maaslin_res_severity_no,maaslin_res_severity_yes)

maaslin_res_severity$feature<-factor(maaslin_res_severity$feature,levels = maaslin_res_severity$feature)


p3 <- ggplot(maaslin_res_severity,aes(x=coef,y=feature))+
  geom_bar(stat = "identity",fill = ifelse(maaslin_res_severity$severity == 'yes',"#E69F00","#56B4E9"),alpha = 0.7)+
  theme_few()
p3
```



##maaslin pathway
```{r}

pathway_meta = read.csv('F:/ZLF/CAP/data/relative_data/metadata-all-220617.csv',row.names = 1)%>% 
  filter(subject != 'healthy') %>% filter(d == 1)

pathway<-read.csv("F:/ZLF/CAP/paper_structure/figure6/pathway/pathway_rel.csv",row.names = 1) %>% select(rownames(pathway_meta))

#View(pathway)

#View(pathway_meta) 

parameter<-c('onsetdays_new','city','age','severe_case','death_case1','sex', 'BMI','pre_immunosuppressive','basic_LRT_disease','pre_biotic','smoke',"respiratory.support.invasive")

fit_data <- Maaslin2(
  input_data = pathway, 
  input_metadata = pathway_meta,
  output = 'C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0905_pathway',
  transform = "AST",
  #normalization = 'NONE',
  fixed_effects = parameter,
  reference ='city,HB'
  #min_prevalence = 0.1,
  #min_abundance = 0.001
  #random_effects = 'subject'
)
```

##pathway plot
```{r}

maaslin_res<-read.table('C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0817_pathway/significant_results.tsv',sep = "\t",header = TRUE, )
#maaslin_res<-read.table('C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0817_pathway/all_results.tsv',sep = "\t",header = TRUE) %>% filter(qval <= 0.3)

#maaslin_res<-read.table('C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0810_filt/all_results.tsv',sep = "\t",header = TRUE) %>% filter(qval <= 0.3)


maaslin_res_severity<-filter(maaslin_res,metadata == 'severe_case') %>% select(feature,value,coef,N,N.not.0,pval,qval)

maaslin_res_severity$severity<-rep('0',length(rownames(maaslin_res_severity)))
for (i in 1:length(rownames(maaslin_res_severity))) {
  if(maaslin_res_severity$coef[i]>0){
    maaslin_res_severity$severity[i] = 'yes'
  }else {
    maaslin_res_severity$severity[i] = 'no'
  }
}

maaslin_res_severity$coef<-sign(maaslin_res_severity$coef)*maaslin_res_severity$coef
maaslin_res_severity<-maaslin_res_severity[order(maaslin_res_severity$coef),]
maaslin_res_severity_yes<-filter(maaslin_res_severity,severity == 'yes')
maaslin_res_severity_no<-filter(maaslin_res_severity,severity == 'no')

maaslin_res_severity<-rbind(maaslin_res_severity_no,maaslin_res_severity_yes)

maaslin_res_severity$feature<-factor(maaslin_res_severity$feature,levels = maaslin_res_severity$feature)


p <- ggplot(maaslin_res_severity,aes(x=coef,y=feature))+
  geom_bar(stat = "identity",fill = ifelse(maaslin_res_severity$severity == 'yes',"#E69F00","#56B4E9"),alpha = 0.7)+
  theme_bw()
p
```

##maaslin city
```{r}

# decontam ----------------------------------------------------------------

library(phyloseq)
library(ggplot2)
library(decontam)

df = read.csv("F:/ZLF/CAP/data/relative_data/0628df.csv",row.names=1)
#%>% select(-starts_with('nc')) %>% select(-starts_with('NC'))
metadata = read.csv('F:/ZLF/CAP/data/relative_data/metadata-all-220617.csv',row.names = 1)
metadata = left_join(metadata,d3 %>% select(raw_id,onset.days.y,onsetdays_new),by = 'raw_id')

rownames(metadata) <- metadata$raw_id

sub.meta <- metadata[colnames(df),] %>% select(raw_id,library,subject)
sub.meta$sample_or_control <- sub.meta$subject

sub.meta[sub.meta[,"subject"] == 'nc' | sub.meta[,"subject"] == 'NCPCR','sample_or_control'] = 'NC'
sub.meta[sub.meta[,"subject"] != 'nc' & sub.meta[,"subject"] != 'NCPCR','sample_or_control'] = 'TS'

sub.meta$is.neg <- sub.meta$sample_or_control == "NC"

d = phyloseq::otu_table(df, taxa_are_rows = T)
d = phyloseq::sample_data(sub.meta)
d
d = phyloseq(otu_table(df, taxa_are_rows = T),sample_data(sub.meta))

contamdf.prev <- isContaminant(d, method="prevalence", neg="is.neg")
table(contamdf.prev$contaminant)
head(which(contamdf.prev$contaminant))

contamdf.prev05 <- isContaminant(d, method="prevalence", neg="is.neg", threshold=0.5)
table(contamdf.prev05$contaminant)

contam <- filter(contamdf.prev,contaminant == 'TRUE') %>% filter(p <= 0.01) %>% rownames()

###
metadata = read.csv('F:/ZLF/CAP/data/relative_data/metadata-all-220617.csv',row.names = 1)
metadata = left_join(metadata,d3 %>% select(raw_id,onset.days.y,onsetdays_new),by = 'raw_id')

df = read.csv("F:/ZLF/CAP/data/relative_data/dfall-220617.csv",
              row.names=1) 
metadata <- filter(metadata,d == 1)
df = read.csv("F:/ZLF/CAP/data/relative_data/dfall-220617.csv",
              row.names=1) %>% t() %>% as.data.frame() %>% select(-intersect(rownames(df),contam))%>% t() %>% as.data.frame()

#df <- decostand(taxonomy_table,'total',2)


submeta1 <- metadata %>% filter(d == 1)
#b <- submeta1 %>% group_by(city) %>% dplyr::summarise(count = n()) %>% as.data.frame() %>% filter(count >= 10)
#b <- b[order(b[,'count'],decreasing = TRUE),]

for (cit in unique(metadata$city)) {
  midcity <-  submeta1
  for (i in 1:nrow(midcity)) {if (midcity$city[i] != cit){midcity$city[i] = 'others' }}
  assign(paste0('metadata',cit),midcity)
}
test.vals = c('onsetdays_new','sex','age','BMI', 
              'city',
              'smoke','basic_LRT_disease','pre_biotic','pre_immunosuppressive',
              'respiratory.support.invasive','death_case1','severe_case') 

#View(metadataWH)
for (cit in unique(metadata$city)) {
  input_metadata <- get(paste0('metadata',cit))
  rownames(input_metadata) <- input_metadata$raw_id
  input_data <- df
  
  input_data<-select(input_data,intersect(colnames(input_data),rownames(input_metadata)))
  
  #View(input_data)
  
  test.vals = c('onsetdays_new','sex','age','BMI', 
                'city',
                'smoke','basic_LRT_disease','pre_biotic','pre_immunosuppressive',
                'respiratory.support.invasive','death_case1','severe_case') 
  
  #input_metadata$mon <- as.character(input_metadata$mon)
  library(Maaslin2)
  output_path = 'F:/ZLF/CAP/maaslin_result0814/'
  fit_data <- Maaslin2(
    input_data = input_data, 
    input_metadata = input_metadata,
    output = paste0(output_path,'0817',cit),
    transform = "AST",
    fixed_effects = test.vals,
    min_prevalence = 0.1,
    min_abundance = 0.001
    #random_effects = 'city,subject'
    #reference = 'sea,spring'
  )
}
```


##city plot
```{r}


metadata = read.csv('F:/ZLF/CAP/data/relative_data/metadata-all-220825.csv',row.names = 1)
df = read.csv("F:/ZLF/CAP/data/relative_data/dfall-220617.csv",row.names=1) 
metadata <- filter(metadata,d == 1)

output_path = 'F:/ZLF/CAP/maaslin_result0814/'

for (cit in unique(metadata$city)) {  
  maaslin_res<-read.table(paste0(output_path,'0817',cit,'/','all_results.tsv'),sep = "\t",header = TRUE) %>% filter(qval <= 0.3)
 
  maaslin_res_severity<-filter(maaslin_res,metadata == 'city')
  
  maaslin_res_severity$city1<-rep('0',length(rownames(maaslin_res_severity)))
  for (i in 1:length(rownames(maaslin_res_severity))) {
    if(is.na(maaslin_res_severity$value)[i]){break} else if(maaslin_res_severity$value[i]=='others'){
      maaslin_res_severity$value[i] = cit
      maaslin_res_severity$coef[i] = -maaslin_res_severity$coef[i]
    }
  }

  
  maaslin_res_severity<-maaslin_res_severity[order(maaslin_res_severity$coef),]
  maaslin_res_severity_yes<-filter(maaslin_res_severity,coef > 0)
  maaslin_res_severity_no<-filter(maaslin_res_severity,coef < 0)
  
  maaslin_res_severity_yes<-maaslin_res_severity_yes[order(maaslin_res_severity_yes$coef,decreasing = TRUE),]
  maaslin_res_severity_no<-maaslin_res_severity_no[order(maaslin_res_severity_no$coef),]
  
  
  maaslin_res_severity<-rbind(maaslin_res_severity_yes,maaslin_res_severity_no)
  
  maaslin_res_severity$feature<-factor(maaslin_res_severity$feature,levels = maaslin_res_severity$feature)
  
  assign(paste0(cit,'microbe'),select(maaslin_res_severity,feature,value,coef))
  
}

citymicrobes <- rbind(WHmicrobe,XAmicrobe) %>% rbind(HBmicrobe) %>% rbind(SZmicrobe) %>% rbind(NJmicrobe) %>% rbind(FJmicrobe)
#citymicrobes <- rbind(WHmicrobe,XAmicrobe) %>% rbind(HBmicrobe) %>%  rbind(NJmicrobe)
#citymicrobes <- rbind(WHmicrobe,XAmicrobe) %>% rbind(HBmicrobe) 
#citymicrobes <- rbind(citymicrobes,HBmicrobe)
#citymicrobes <- rbind(citymicrobes,NJmicrobe)


colnames(citymicrobes)<- c('feature','city','value')
#View(citymicrobes)

citymicro <- dcast(citymicrobes,feature~city)

rownames(citymicro) <- citymicro$feature
citymicro <- select(citymicro,-feature)
i = 1
#citymicro <- select(citymicro,setdiff(b$city,'SZ'))
for (i in 1:nrow(citymicro)) {
  citymicro[i,is.na(citymicro[i,])] = 0
}
citymicro <- select(citymicro,WH,XA,HB,SZ,NJ,FJ)
#citymicro <- select(citymicro,WH,XA,HB,SZ,NJ)
#citymicro <- select(citymicro,WH,XA,HB)
bk = seq(-0.15, 0.15, by = 0.005)
bk <- c(seq(-0.15,-0.000001,by=0.001),seq(0,0.15,by=0.001))
library(pheatmap)
p<-pheatmap(citymicro,
            cluster_row = FALSE,
            cluster_cols = FALSE,
            breaks = bk,
            #legend_breaks = seq(-0.15,0.15,0.05),            #display_numbers = TRUE,
            na_col = "white",
            #"darkred",'white',"steelblue4"
            color = c(colorRampPalette(colors = c("steelblue4",'white'))(length(bk)/2),colorRampPalette(colors = c('white',"darkred"))(length(bk)/2))
            #color = c(colorRampPalette(colors = c("#56B4E9",'white'))(length(bk)/2),colorRampPalette(colors = c('white',"#E69F00"))(length(bk)/2))
            #color = colorRampPalette(c("steelblue4",'white',"darkred"))(100)
            #file="F:/ZLF/CAP/paper_structure/figure1/csjsddistance4.pdf",
)

p
```

##city plot decontam
```{r}

```


##permanova healthy cap
```{r}
metadata = read.csv('F:/ZLF/CAP/data/relative_data/metadata-all-220825.csv',row.names = 1)
df = read.csv("F:/ZLF/CAP/data/relative_data/dfall-220617.csv",row.names=1)
hea <- filter(metadata,subject == 'healthy')
cap <- filter(metadata, d == 1)

meta1 <- rbind(hea,cap)

  d1.meta = meta1
  rownames(d1.meta) <- d1.meta$raw_id
  d1.df = df[,rownames(d1.meta)] %>% t() %>% as.data.frame()
  #View(sub.df)
  OTU = phyloseq::otu_table(d1.df, taxa_are_rows = F)
  physeq = phyloseq(OTU)
  jsd=phyloseq::distance(physeq, method = "jsd")
  
  res = adonis(as.formula(paste0("jsd~",'healthy')),
               data = d1.meta, permutations = 999)
  res

```

##lefse plot
```{r}
lefse <- read.table('F:/ZLF/CAP/paper_structure/figure2/severity_lefse.txt',sep = '\t')
rownames(lefse)<-lefse$V1
#lefse<-lefse[,-1]
colnames(lefse)<-c('tax','V2','severity','LDA','pvalue')
#help("read.table")
lefse = lefse[!is.na(lefse[,'LDA']),]%>%filter(LDA >= 4)

lefse_y<-filter(lefse,severity == 'yes')
lefse_n<-filter(lefse,severity == 'no')

lefse<-rbind(lefse_n,lefse_y)
lefse$tax<-factor(lefse$tax,levels = lefse$tax)

lefse1 <- filter(lefse,severity == 'no')
lefse1 <- lefse1[order(lefse1[,'LDA']),]
lefse2 <- filter(lefse,severity == 'yes')
lefse2 <- lefse2[order(lefse2[,'LDA']),]

lefse <- rbind(lefse1,lefse2)

lefse$tax <- factor(lefse$tax,levels = lefse$tax)

p <- ggplot(lefse,aes(x = LDA,y = tax))+
  #geom_col(aes(fill = severity))+
  geom_bar(stat = "identity",fill = ifelse(lefse$severity == 'yes',"#E69F00","#56B4E9"),alpha = 0.8)+
  theme_bw()
p
```



##maaslin pathway
```{r}

pathway_meta = read.csv('F:/ZLF/CAP/data/relative_data/metadata-all-220617.csv',row.names = 1)%>% 
  filter(subject != 'healthy') %>% filter(d == 1)

pathway<-read.csv("F:/ZLF/CAP/paper_structure/figure6/pathway/pathway_rel.csv",row.names = 1) %>% select(rownames(pathway_meta))

#View(pathway)

#View(pathway_meta) 

parameter<-c('city','age','severe_case','death_case1',"respiratory.support.invasive")

fit_data <- Maaslin2(
  input_data = pathway, 
  input_metadata = pathway_meta,
  output = 'C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0905_pathway',
  transform = "AST",
  #normalization = 'NONE',
  fixed_effects = parameter,
  reference ='city,HB'
  #min_prevalence = 0.1,
  #min_abundance = 0.001
  #random_effects = 'subject'
)
```

##pathway plot
```{r}

maaslin_res<-read.table('C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0905_pathway/significant_results.tsv',sep = "\t",header = TRUE, )
#maaslin_res<-read.table('C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0817_pathway/all_results.tsv',sep = "\t",header = TRUE) %>% filter(qval <= 0.3)

#maaslin_res<-read.table('C:/Users/lenovo_2/Desktop/CAP0704/maaslin_0810_filt/all_results.tsv',sep = "\t",header = TRUE) %>% filter(qval <= 0.3)


maaslin_res_severity<-filter(maaslin_res,metadata == 'severe_case') %>% select(feature,value,coef,N,N.not.0,pval,qval)

maaslin_res_severity$severity<-rep('0',length(rownames(maaslin_res_severity)))
for (i in 1:length(rownames(maaslin_res_severity))) {
  if(maaslin_res_severity$coef[i]>0){
    maaslin_res_severity$severity[i] = 'yes'
  }else {
    maaslin_res_severity$severity[i] = 'no'
  }
}

maaslin_res_severity$coef<-sign(maaslin_res_severity$coef)*maaslin_res_severity$coef
maaslin_res_severity<-maaslin_res_severity[order(maaslin_res_severity$coef),]
maaslin_res_severity_yes<-filter(maaslin_res_severity,severity == 'yes')
maaslin_res_severity_no<-filter(maaslin_res_severity,severity == 'no')

maaslin_res_severity<-rbind(maaslin_res_severity_no,maaslin_res_severity_yes)

maaslin_res_severity$feature<-factor(maaslin_res_severity$feature,levels = maaslin_res_severity$feature)


p <- ggplot(maaslin_res_severity,aes(x=coef,y=feature))+
  geom_bar(stat = "identity",fill = ifelse(maaslin_res_severity$severity == 'yes',"#E69F00","#56B4E9"),alpha = 0.7)+
  theme_bw()
p
```



##maaslin city
```{r}

# decontam ----------------------------------------------------------------

library(phyloseq)
library(ggplot2)
library(decontam)

df = read.csv("F:/ZLF/CAP/data/relative_data/0628df.csv",row.names=1)
#%>% select(-starts_with('nc')) %>% select(-starts_with('NC'))
metadata = read.csv('F:/ZLF/CAP/data/relative_data/metadata-all-220617.csv',row.names = 1)
#metadata = left_join(metadata,d3 %>% select(raw_id,onset.days.y,onsetdays_new),by = 'raw_id')

rownames(metadata) <- metadata$raw_id

sub.meta <- metadata[colnames(df),] %>% select(raw_id,library,subject)
sub.meta$sample_or_control <- sub.meta$subject

sub.meta[sub.meta[,"subject"] == 'nc' | sub.meta[,"subject"] == 'NCPCR','sample_or_control'] = 'NC'
sub.meta[sub.meta[,"subject"] != 'nc' & sub.meta[,"subject"] != 'NCPCR','sample_or_control'] = 'TS'

sub.meta$is.neg <- sub.meta$sample_or_control == "NC"

d = phyloseq::otu_table(df, taxa_are_rows = T)
d = phyloseq::sample_data(sub.meta)
d
d = phyloseq(otu_table(df, taxa_are_rows = T),sample_data(sub.meta))

contamdf.prev <- isContaminant(d, method="prevalence", neg="is.neg")
table(contamdf.prev$contaminant)
head(which(contamdf.prev$contaminant))

contamdf.prev05 <- isContaminant(d, method="prevalence", neg="is.neg", threshold=0.5)
table(contamdf.prev05$contaminant)

contam <- filter(contamdf.prev,contaminant == 'TRUE') %>% filter(p <= 0.01) %>% rownames()

###
metadata = read.csv('F:/ZLF/CAP/data/relative_data/metadata-all-220617.csv',row.names = 1)
#metadata = left_join(metadata,d3 %>% select(raw_id,onset.days.y,onsetdays_new),by = 'raw_id')

df = read.csv("F:/ZLF/CAP/data/relative_data/dfall-220617.csv",
              row.names=1) 
metadata <- filter(metadata,d == 1)
df = read.csv("F:/ZLF/CAP/data/relative_data/dfall-220617.csv",
              row.names=1) %>% t() %>% as.data.frame() %>% select(-intersect(rownames(df),contam))%>% t() %>% as.data.frame()

#df <- decostand(taxonomy_table,'total',2)


submeta1 <- metadata %>% filter(d == 1)
#b <- submeta1 %>% group_by(city) %>% dplyr::summarise(count = n()) %>% as.data.frame() %>% filter(count >= 10)
#b <- b[order(b[,'count'],decreasing = TRUE),]

for (cit in unique(metadata$city)) {
  midcity <-  submeta1
  for (i in 1:nrow(midcity)) {if (midcity$city[i] != cit){midcity$city[i] = 'others' }}
  assign(paste0('metadata',cit),midcity)
}
test.vals = c('age','city','respiratory.support.invasive','death_case1','severe_case') 

#View(metadataWH)
for (cit in unique(metadata$city)) {
  input_metadata <- get(paste0('metadata',cit))
  rownames(input_metadata) <- input_metadata$raw_id
  input_data <- df
  
  input_data<-select(input_data,intersect(colnames(input_data),rownames(input_metadata)))
  
  #View(input_data)
  
  test.vals = c('age','city','respiratory.support.invasive','death_case1','severe_case') 
  
  #input_metadata$mon <- as.character(input_metadata$mon)
  library(Maaslin2)
  output_path = 'F:/ZLF/CAP/maaslin_result0814/'
  fit_data <- Maaslin2(
    input_data = input_data, 
    input_metadata = input_metadata,
    output = paste0(output_path,'0906',cit),
    transform = "AST",
    fixed_effects = test.vals,
    min_prevalence = 0.1,
    min_abundance = 0.001
    #random_effects = 'city,subject'
    #reference = 'sea,spring'
  )
}
```


##city plot
```{r}


metadata = read.csv('F:/ZLF/CAP/data/relative_data/metadata-all-220825.csv',row.names = 1)
df = read.csv("F:/ZLF/CAP/data/relative_data/dfall-220617.csv",row.names=1) 
metadata <- filter(metadata,d == 1)

output_path = 'F:/ZLF/CAP/maaslin_result0814/'

for (cit in unique(metadata$city)) {  
  maaslin_res<-read.table(paste0(output_path,'0906',cit,'/','all_results.tsv'),sep = "\t",header = TRUE) %>% filter(qval <= 0.3)
 
  maaslin_res_severity<-filter(maaslin_res,metadata == 'city')
  
  maaslin_res_severity$city1<-rep('0',length(rownames(maaslin_res_severity)))
  for (i in 1:length(rownames(maaslin_res_severity))) {
    if(is.na(maaslin_res_severity$value)[i]){break} else if(maaslin_res_severity$value[i]=='others'){
      maaslin_res_severity$value[i] = cit
      maaslin_res_severity$coef[i] = -maaslin_res_severity$coef[i]
    }
  }

  
  maaslin_res_severity<-maaslin_res_severity[order(maaslin_res_severity$coef),]
  maaslin_res_severity_yes<-filter(maaslin_res_severity,coef > 0)
  maaslin_res_severity_no<-filter(maaslin_res_severity,coef < 0)
  
  maaslin_res_severity_yes<-maaslin_res_severity_yes[order(maaslin_res_severity_yes$coef,decreasing = TRUE),]
  maaslin_res_severity_no<-maaslin_res_severity_no[order(maaslin_res_severity_no$coef),]
  
  
  maaslin_res_severity<-rbind(maaslin_res_severity_yes,maaslin_res_severity_no)
  
  maaslin_res_severity$feature<-factor(maaslin_res_severity$feature,levels = maaslin_res_severity$feature)
  
  assign(paste0(cit,'microbe'),select(maaslin_res_severity,feature,value,coef))
  
}

citymicrobes <- rbind(WHmicrobe,XAmicrobe) %>% rbind(HBmicrobe) %>% rbind(SZmicrobe) %>% rbind(NJmicrobe) %>% rbind(FJmicrobe)
#citymicrobes <- rbind(WHmicrobe,XAmicrobe) %>% rbind(HBmicrobe) %>%  rbind(NJmicrobe)
#citymicrobes <- rbind(WHmicrobe,XAmicrobe) %>% rbind(HBmicrobe) 
#citymicrobes <- rbind(citymicrobes,HBmicrobe)
#citymicrobes <- rbind(citymicrobes,NJmicrobe)


colnames(citymicrobes)<- c('feature','city','value')
#View(citymicrobes)

citymicro <- dcast(citymicrobes,feature~city)

rownames(citymicro) <- citymicro$feature
citymicro <- select(citymicro,-feature)
i = 1
#citymicro <- select(citymicro,setdiff(b$city,'SZ'))
for (i in 1:nrow(citymicro)) {
  citymicro[i,is.na(citymicro[i,])] = 0
}
citymicro <- select(citymicro,WH,XA,HB,SZ,NJ,FJ)
#citymicro <- select(citymicro,WH,XA,HB,SZ,NJ)
#citymicro <- select(citymicro,WH,XA,HB)
bk = seq(-0.15, 0.15, by = 0.005)
bk <- c(seq(-0.15,-0.000001,by=0.001),seq(0,0.15,by=0.001))
library(pheatmap)
p<-pheatmap(citymicro,
            cluster_row = FALSE,
            cluster_cols = FALSE,
            breaks = bk,
            #legend_breaks = seq(-0.15,0.15,0.05),            #display_numbers = TRUE,
            na_col = "white",
            #"darkred",'white',"steelblue4"
            color = c(colorRampPalette(colors = c("steelblue4",'white'))(length(bk)/2),colorRampPalette(colors = c('white',"darkred"))(length(bk)/2))
            #color = c(colorRampPalette(colors = c("#56B4E9",'white'))(length(bk)/2),colorRampPalette(colors = c('white',"#E69F00"))(length(bk)/2))
            #color = colorRampPalette(c("steelblue4",'white',"darkred"))(100)
            #file="F:/ZLF/CAP/paper_structure/figure1/csjsddistance4.pdf",
)

p
```

##decontam city plot
```{r}
###
metadata = read.csv('F:/ZLF/CAP/data/relative_data/metadata-all-220617.csv',row.names = 1)
df = read.csv("F:/ZLF/CAP/data/relative_data/dfall-220617.csv",
              row.names=1) %>% t() %>% as.data.frame() %>% select(-intersect(rownames(df),contam))%>% t() %>% as.data.frame()

#df <- decostand(taxonomy_table,'total',2)


submeta1 <- metadata %>% filter(d == 1)
#b <- submeta1 %>% group_by(city) %>% dplyr::summarise(count = n()) %>% as.data.frame() %>% filter(count >= 10)
#b <- b[order(b[,'count'],decreasing = TRUE),]

for (cit in unique(metadata$city)) {
  midcity <-  submeta1
  for (i in 1:nrow(midcity)) {if (midcity$city[i] != cit){midcity$city[i] = 'others' }}
  assign(paste0('metadata',cit),midcity)
}
test.vals = c('age','city','respiratory.support.invasive','death_case1','severe_case') 

#View(metadataWH)
for (cit in unique(metadata$city)) {
  input_metadata <- get(paste0('metadata',cit))
  rownames(input_metadata) <- input_metadata$raw_id
  input_data <- df
  
  input_data<-select(input_data,intersect(colnames(input_data),rownames(input_metadata)))
  
  #View(input_data)
  
  test.vals = c('age','city','respiratory.support.invasive','death_case1','severe_case') 
  
  #input_metadata$mon <- as.character(input_metadata$mon)
  library(Maaslin2)
  output_path = 'F:/ZLF/CAP/maaslin_result0814/'
  fit_data <- Maaslin2(
    input_data = input_data, 
    input_metadata = input_metadata,
    output = paste0(output_path,'0906',cit),
    transform = "AST",
    fixed_effects = test.vals,
    min_prevalence = 0.1,
    min_abundance = 0.001
    #random_effects = 'city,subject'
    #reference = 'sea,spring'
  )
}


```


##city plot
```{r}


metadata = read.csv('F:/ZLF/CAP/data/relative_data/metadata-all-220825.csv',row.names = 1)
df = read.csv("F:/ZLF/CAP/data/relative_data/dfall-220617.csv",row.names=1) 
metadata <- filter(metadata,d == 1)

output_path = 'F:/ZLF/CAP/maaslin_result0814/'

for (cit in unique(metadata$city)) {  
  maaslin_res<-read.table(paste0(output_path,'0906',cit,'/','all_results.tsv'),sep = "\t",header = TRUE) %>% filter(qval <= 0.25)
 
  maaslin_res_severity<-filter(maaslin_res,metadata == 'city')
  
  maaslin_res_severity$city1<-rep('0',length(rownames(maaslin_res_severity)))
  for (i in 1:length(rownames(maaslin_res_severity))) {
    if(is.na(maaslin_res_severity$value)[i]){break} else if(maaslin_res_severity$value[i]=='others'){
      maaslin_res_severity$value[i] = cit
      maaslin_res_severity$coef[i] = -maaslin_res_severity$coef[i]
    }
  }

  
  maaslin_res_severity<-maaslin_res_severity[order(maaslin_res_severity$coef),]
  maaslin_res_severity_yes<-filter(maaslin_res_severity,coef > 0)
  maaslin_res_severity_no<-filter(maaslin_res_severity,coef < 0)
  
  maaslin_res_severity_yes<-maaslin_res_severity_yes[order(maaslin_res_severity_yes$coef,decreasing = TRUE),]
  maaslin_res_severity_no<-maaslin_res_severity_no[order(maaslin_res_severity_no$coef),]
  
  
  maaslin_res_severity<-rbind(maaslin_res_severity_yes,maaslin_res_severity_no)
  
  maaslin_res_severity$feature<-factor(maaslin_res_severity$feature,levels = maaslin_res_severity$feature)
  
  assign(paste0(cit,'microbe'),select(maaslin_res_severity,feature,value,coef))
  
}

citymicrobes <- rbind(WHmicrobe,XAmicrobe) %>% rbind(HBmicrobe) %>% rbind(SZmicrobe) %>% rbind(NJmicrobe) %>% rbind(FJmicrobe)
#citymicrobes <- rbind(WHmicrobe,XAmicrobe) %>% rbind(HBmicrobe) %>%  rbind(NJmicrobe)
#citymicrobes <- rbind(WHmicrobe,XAmicrobe) %>% rbind(HBmicrobe) 
#citymicrobes <- rbind(citymicrobes,HBmicrobe)
#citymicrobes <- rbind(citymicrobes,NJmicrobe)


colnames(citymicrobes)<- c('feature','city','value')
#View(citymicrobes)

citymicro <- dcast(citymicrobes,feature~city)

rownames(citymicro) <- citymicro$feature
citymicro <- select(citymicro,-feature)
i = 1
#citymicro <- select(citymicro,setdiff(b$city,'SZ'))
for (i in 1:nrow(citymicro)) {
  citymicro[i,is.na(citymicro[i,])] = 0
}
citymicro <- select(citymicro,WH,XA,HB,SZ,NJ,FJ)
#citymicro <- select(citymicro,WH,XA,HB,SZ,NJ)
#citymicro <- select(citymicro,WH,XA,HB)
bk = seq(-0.15, 0.15, by = 0.005)
bk <- c(seq(-0.15,-0.000001,by=0.001),seq(0,0.15,by=0.001))
library(pheatmap)
p<-pheatmap(citymicro,
            cluster_row = FALSE,
            cluster_cols = FALSE,
            breaks = bk,
            #legend_breaks = seq(-0.15,0.15,0.05),            #display_numbers = TRUE,
            na_col = "white",
            #"darkred",'white',"steelblue4"
            color = c(colorRampPalette(colors = c("steelblue4",'white'))(length(bk)/2),colorRampPalette(colors = c('white',"darkred"))(length(bk)/2))
            #color = c(colorRampPalette(colors = c("#56B4E9",'white'))(length(bk)/2),colorRampPalette(colors = c('white',"#E69F00"))(length(bk)/2))
            #color = colorRampPalette(c("steelblue4",'white',"darkred"))(100)
            #file="F:/ZLF/CAP/paper_structure/figure1/csjsddistance4.pdf",
)

p
```

##death case的时序变化

```{r}
metadata = read.csv('F:/ZLF/CAP/data/relative_data/metadata-all-220825.csv',row.names = 1)
df = read.csv("F:/ZLF/CAP/data/relative_data/dfall-220617.csv",row.names=1) 

sub.meta <- filter(metadata,death_case1 == 'yes')
rownames(sub.meta) <- sub.meta$raw_id

sub.df <- df[,rownames(sub.meta)] 

sub.df$sum <- apply(sub.df,1,sum)
sub.df <- sub.df[order(sub.df[,'sum'],decreasing = T),]
sub.df <-  sub.df[1:15,-ncol(sub.df)]
sub.df['others',] <- 0
for (i in 1:ncol(sub.df)) {
  sub.df['others',i]  <- 1- sum(sub.df[,i])
}

sub.df$taxonomy <-  rownames(sub.df)

taxonomy_table1<-melt(sub.df,id.vars = "taxonomy",variable.name = "variable",value.name = "value")

colnames(taxonomy_table1)[2] <- 'raw_id'
plot1 <- left_join(taxonomy_table1,select(sub.meta,raw_id,d,subject))

p<-ggplot(plot1,mapping=aes(x=raw_id,y=value*100,fill=taxonomy))+
  geom_col(position = "stack",width = 0.8)+
  #  labs(x = '', y = 'Relative Abundance(%)',title = "genus abundance") +
  labs(x = '', y = '',title = "") +
  #facet_grid(~subject,scales="free",space= "free" )+
  facet_wrap(~subject,scales="free_x",)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  theme(legend.text = element_text(size = 10))+
  theme(panel.grid = element_blank(), panel.background = element_rect(color = 'black', fill = 'transparent')) +
  theme(legend.title = element_blank())+
  scale_fill_manual(values = c('#CC3333',"#8FBC94","#4FB0C6","#00CC99","#6E7783","#e97f02","#3a5134",                             "#CC9999",'#1f77b4','#aec7e8','#98df8a',"#F0E442",'#c5b0d5',"#339966",'darkred','blue'))
p
```

##cs9的distance
```{r}
metadata = read.csv('F:/ZLF/CAP/data/relative_data/metadata-all-220617.csv',row.names = 1)

for (i in 1:10) {
  assign(paste0('cs',i),filter(metadata,pam_10_cluster == i))
}

OTU<-otu_table(df %>% as.matrix(),taxa_are_rows = TRUE)
samples<-sample_data(metadata)
#phyloseq
phytest<-phyloseq(OTU,samples)
#计算距离
sd<-distance(phytest,method = "jsd")
sdm<-as.matrix(sd)

sd.m = melt(as.matrix(sd))

sdmcs10 = sdm

tran<-data.frame(matrix(nrow = 10,ncol = 10))
colnames(tran)<-1:10
for (i in 1:10) {
  for (j in setdiff(1:10,(i+1):11)) {
    mid<-melt(sdm[rownames(filter(metadata,pam_10_cluster == i)),rownames(filter(metadata,pam_10_cluster == j))])
    tran[i,j] = median(mid$value)
    #tran[i,j] = quantile(mid$value)[[4]]
    #tran[i,j] =mean(mid$value)
  }
}
#quantile(mid)[[4]]


brewer.pal(n = 8, name = "Set1")[1:10]
ann_colors = list(severe_case = c(yes = "#E69F00", no = "#56B4E9"))
#, NJ = "#4DAF4A", SZ = "#984EA3", WH = "#FF7F00", XA = "#A65628"))


library(pheatmap)
rownames(tran) <- 1:10
p<-pheatmap(tran,
         cluster_row = FALSE,
         cluster_cols = FALSE,
         display_numbers = TRUE,
         na_col = "white",
         #color = colorRampPalette(c("deepskyblue","deepskyblue4"))(100)
         #file="F:/ZLF/CAP/paper_structure/figure1/csjsddistance4.pdf",
         )

p
```


##cs11 的distance
```{r}
metadata = read.csv('C:/Users/lenovo_2/Desktop/CAP0704/cluster0811/meta_new_cluster0830-11.csv',row.names = 1)

for (i in 1:12) {
  assign(paste0('cs',i),filter(metadata,pam_10_cluster == i))
}


OTU<-otu_table(df %>% as.matrix(),taxa_are_rows = TRUE)
samples<-sample_data(metadata)
#phyloseq
phytest<-phyloseq(OTU,samples)
#计算距离
sd<-distance(phytest,method = "jsd")
sdm<-as.matrix(sd)

sd.m = melt(as.matrix(sd))

sdmcs12 = sdm


tran<-data.frame(matrix(nrow = 12,ncol = 12))
colnames(tran)<-1:12
for (i in 1:12) {
  for (j in setdiff(1:12,(i+1):13)) {
    mid<-melt(sdm[rownames(filter(metadata,pam_10_cluster == i)),rownames(filter(metadata,pam_10_cluster == j))])
    tran[i,j] = median(mid$value)
    #tran[i,j] = quantile(mid$value)[[4]]
    #tran[i,j] =mean(mid$value)
  }
}
#quantile(mid)[[4]]


brewer.pal(n = 8, name = "Set1")[1:12]
ann_colors = list(severe_case = c(yes = "#E69F00", no = "#56B4E9"))
#, NJ = "#4DAF4A", SZ = "#984EA3", WH = "#FF7F00", XA = "#A65628"))


library(pheatmap)
rownames(tran) <- 1:12
p<-pheatmap(tran,
         cluster_row = FALSE,
         cluster_cols = FALSE,
         display_numbers = TRUE,
         na_col = "white",
         #color = colorRampPalette(c("deepskyblue","deepskyblue4"))(100)
         #file="F:/ZLF/CAP/paper_structure/figure1/csjsddistance4.pdf",
         )

p
```

##pcoa cs10
```{r}
metadata = read.csv('F:/ZLF/CAP/data/relative_data/metadata-all-220617.csv',row.names = 1)

sub.meta <- metadata %>% filter(subject != 'healthy' & subject != 'nc' & subject != 'NCPCR')
sub.df <- df[,rownames(sub.meta)] %>% t() %>% as.data.frame()

val = 'pam_10_cluster'

OTU = phyloseq::otu_table(sub.df, taxa_are_rows = F)
physeq = phyloseq(OTU)
jsd=phyloseq::distance(physeq, method = "jsd")
jsd.cord = cmdscale(jsd,k=2,eig = T)

#制作绘图文件
PC1 = jsd.cord$points[,1]
PC2 = jsd.cord$points[,2]
plotdata <- data.frame(rownames(jsd.cord$points),PC1,PC2,sub.meta[,val])
colnames(plotdata) <-c("sample","PC1","PC2","group")


#用于填充样本点的颜色
cbbPalette <- c( "#56B4E9","#E69F00", "#009E73", "#F0E442","red","grey")
cbbPalette <- brewer.pal(n = 12, name = "Set3")[1:12]
#样本点的边框颜色
Palette <- c("#000000", "#000000","#000000","#000000","#000000","#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000")
#用于绘制横纵坐标label的文本，以显示解释比例
eigen.vals.jsd = jsd.cord$eig
last_one = sum(eigen.vals.jsd>0)
pc1 <-floor(eigen.vals.jsd[1]*100/sum(eigen.vals.jsd[1:last_one])) 
pc2 <-floor(eigen.vals.jsd[2]*100/sum(eigen.vals.jsd[1:last_one])) 

pich=rep(c(21:24),3)

f2e_plot1 <- merge(plotdata,aggregate(cbind(mean.x=PC1,mean.y=PC2)~group,plotdata,mean),by="group")

#匹配横纵坐标
f2e1 = ggplot(f2e_plot1, aes(PC1, PC2,)) +
  #绘制样本点，根据分组匹配颜色和形状，size调整点的大小
  geom_point(aes(colour=group,shape=group,fill=group),size=4)+
  geom_segment(aes(x=mean.x,y=mean.y,xend=PC1, yend=PC2,color =  group),alpha=0.15)+
  #匹配形状、边框和填充的图例
  scale_shape_manual(values=pich)+
  scale_colour_manual(values=Palette)+
  scale_fill_manual(values=cbbPalette)+
  #设置标题和横纵坐标label文字
  #labs(title=paste0("PCoA-",val)) + 
  #labs(title="Severity",size=15) + 
  xlab(paste("PCoA1 ( ",pc1,"%"," )",sep="")) + 
  ylab(paste("PCoA2 ( ",pc2,"%"," )",sep=""))+
  theme(text=element_text(size=15))+
  #添加横纵两条虚线
  geom_vline(aes(xintercept = 0),linetype="dotted")+
  geom_hline(aes(yintercept = 0),linetype="dotted")+
  #调整背景、坐标轴、图例的格式
  theme(panel.background = element_rect(fill='white', colour='black'),
        panel.grid=element_blank(), 
        axis.title = element_text(color='black',size=10),
        axis.ticks.length = unit(0.4,"lines"), axis.ticks = element_line(color='black'),
        axis.line = element_line(colour = "black"), 
        axis.title.x=element_text(colour='black', size=18),
        axis.title.y=element_text(colour='black', size=18),
        axis.text=element_text(colour='black',size=18),
        legend.title=element_blank(),
        legend.text=element_text(size=18),
        legend.key=element_blank(),
        legend.background = element_rect(colour = "black"),
        legend.key.height=unit(1.6,"cm"))+
  #annotate("text", x = 0.34, y = 0.3, label = "R=0.024",size=4) + 
  #设置标题的格式
  theme(plot.title = element_text(size=34,colour = "black",hjust = 0.5,face = "bold")) + 
  stat_ellipse(aes(fill = group),geom = "polygon",level = 0.95,alpha = 0.3)+
  ggrepel::geom_label_repel(data=unique(select(f2e_plot ,mean.x,mean.y,group)),
                            aes(mean.x,mean.y,color=group),
                            #label=c('quit','non-smoke','somke'),
                            label=c(unique(f2e_plot $group)),
                            #fontface="bold",show.legend = F,box.padding = 0,size=1.5)
                            fontface="bold",show.legend = F,box.padding = 0,size=4)
#pdf(paste0(paste0('E:/春节期间笔记/CorrelationAnalysis/pcoa_',val),'.pdf'),width = 8,height = 6)
f2e1


```


##pcoacs12

```{r}
metadata = read.csv('C:/Users/lenovo_2/Desktop/CAP0704/cluster0811/meta_new_cluster0830-11.csv',row.names = 1)
sub.meta <- metadata %>% filter(subject != 'healthy' & subject != 'nc' & subject != 'NCPCR')
sub.df <- df[,rownames(sub.meta)] %>% t() %>% as.data.frame()

val = 'pam_10_cluster'

OTU = phyloseq::otu_table(sub.df, taxa_are_rows = F)
physeq = phyloseq(OTU)
jsd=phyloseq::distance(physeq, method = "jsd")
jsd.cord = cmdscale(jsd,k=2,eig = T)

#制作绘图文件
PC1 = jsd.cord$points[,1]
PC2 = jsd.cord$points[,2]
plotdata <- data.frame(rownames(jsd.cord$points),PC1,PC2,sub.meta[,val])
colnames(plotdata) <-c("sample","PC1","PC2","group")


#用于填充样本点的颜色
cbbPalette <- c( "#56B4E9","#E69F00", "#009E73", "#F0E442","red","grey")
cbbPalette <- brewer.pal(n = 12, name = "Set3")[1:12]
#样本点的边框颜色
Palette <- c("#000000", "#000000","#000000","#000000","#000000","#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000", "#000000")
#用于绘制横纵坐标label的文本，以显示解释比例
eigen.vals.jsd = jsd.cord$eig
last_one = sum(eigen.vals.jsd>0)
pc1 <-floor(eigen.vals.jsd[1]*100/sum(eigen.vals.jsd[1:last_one])) 
pc2 <-floor(eigen.vals.jsd[2]*100/sum(eigen.vals.jsd[1:last_one])) 

pich=rep(c(21:24),3)

f2e_plot1 <- merge(plotdata,aggregate(cbind(mean.x=PC1,mean.y=PC2)~group,plotdata,mean),by="group")
f2e_plot1$group <- as.character(f2e_plot1$group)
#匹配横纵坐标
f2e1 = ggplot(f2e_plot1, aes(PC1, PC2,)) +
  #绘制样本点，根据分组匹配颜色和形状，size调整点的大小
  geom_point(aes(colour=group,shape=group,fill=group),size=4)+
  geom_segment(aes(x=mean.x,y=mean.y,xend=PC1, yend=PC2,color =  group),alpha=0.15)+
  #匹配形状、边框和填充的图例
  scale_shape_manual(values=pich)+
  scale_colour_manual(values=Palette)+
  scale_fill_manual(values=cbbPalette)+
  #设置标题和横纵坐标label文字
  #labs(title=paste0("PCoA-",val)) + 
  #labs(title="Severity",size=15) + 
  xlab(paste("PCoA1 ( ",pc1,"%"," )",sep="")) + 
  ylab(paste("PCoA2 ( ",pc2,"%"," )",sep=""))+
  theme(text=element_text(size=15))+
  #添加横纵两条虚线
  geom_vline(aes(xintercept = 0),linetype="dotted")+
  geom_hline(aes(yintercept = 0),linetype="dotted")+
  #调整背景、坐标轴、图例的格式
  theme(panel.background = element_rect(fill='white', colour='black'),
        panel.grid=element_blank(), 
        axis.title = element_text(color='black',size=10),
        axis.ticks.length = unit(0.4,"lines"), axis.ticks = element_line(color='black'),
        axis.line = element_line(colour = "black"), 
        axis.title.x=element_text(colour='black', size=18),
        axis.title.y=element_text(colour='black', size=18),
        axis.text=element_text(colour='black',size=18),
        legend.title=element_blank(),
        legend.text=element_text(size=18),
        legend.key=element_blank(),
        legend.background = element_rect(colour = "black"),
        legend.key.height=unit(1.6,"cm"))+
  #annotate("text", x = 0.34, y = 0.3, label = "R=0.024",size=4) + 
  #设置标题的格式
  theme(plot.title = element_text(size=34,colour = "black",hjust = 0.5,face = "bold")) + 
  stat_ellipse(aes(fill = group),geom = "polygon",level = 0.95,alpha = 0.3)+
  ggrepel::geom_label_repel(data=unique(select(f2e_plot1 ,mean.x,mean.y,group)),
                            aes(mean.x,mean.y,color=group),
                            #label=c('quit','non-smoke','somke'),
                            label=c(unique(f2e_plot1 $group)),
                            #fontface="bold",show.legend = F,box.padding = 0,size=1.5)
                            fontface="bold",show.legend = F,box.padding = 0,size=4)
#pdf(paste0(paste0('E:/春节期间笔记/CorrelationAnalysis/pcoa_',val),'.pdf'),width = 8,height = 6)
f2e1

```
